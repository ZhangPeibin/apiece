"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.loadBinding = void 0;
const fs_1 = require("fs");
const os_1 = require("os");
const path_1 = require("path");
const triples_1 = require("@napi-rs/triples");
const ArchName = os_1.arch();
const PlatformName = os_1.platform();
function loadBinding(dirname, filename = 'index', packageName) {
    var _a;
    const triples = triples_1.platformArchTriples[PlatformName][ArchName];
    let additionalErrorMsg = '';
    for (const triple of triples) {
        if (packageName) {
            try {
                return require(require.resolve(`${packageName}-${triple.platformArchABI}`, { paths: [dirname] }));
            }
            catch (e) {
                if ((e === null || e === void 0 ? void 0 : e.code) !== 'MODULE_NOT_FOUND') {
                    try {
                        const pkgPath = require.resolve(`${packageName}-${triple.platformArchABI}`, { paths: [dirname] });
                        additionalErrorMsg += `file: ${pkgPath} existed but error occurred while require it: ${(_a = e.message) !== null && _a !== void 0 ? _a : e} \n`;
                    }
                    catch (_b) { }
                }
            }
        }
        const localFilePath = path_1.join(dirname, `${filename}.${triple.platformArchABI}.node`);
        if (fs_1.existsSync(localFilePath)) {
            return require(localFilePath);
        }
    }
    let packageList = '';
    if (packageName) {
        try {
            const packageNameWithoutNamespace = packageName.split('/').pop();
            packageList = fs_1.readdirSync(path_1.join(require.resolve(packageName, { paths: [dirname] }), '..', '..'))
                .filter((d) => d !== packageNameWithoutNamespace && d.startsWith(packageNameWithoutNamespace))
                .join(', ');
        }
        catch (_c) { }
    }
    const errorMsg = `Can not load bindings${additionalErrorMsg ? ', ' + additionalErrorMsg : '\n'}${packageList ? 'Installed packages: [' + packageList + ']' : ''}`;
    throw new Error(errorMsg);
}
exports.loadBinding = loadBinding;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2xvYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQkFBNEM7QUFDNUMsMkJBQW1DO0FBQ25DLCtCQUEyQjtBQUUzQiw4Q0FBc0Q7QUFFdEQsTUFBTSxRQUFRLEdBQUcsU0FBSSxFQUFFLENBQUE7QUFDdkIsTUFBTSxZQUFZLEdBQUcsYUFBUSxFQUFFLENBQUE7QUFFL0IsU0FBZ0IsV0FBVyxDQUFDLE9BQWUsRUFBRSxRQUFRLEdBQUcsT0FBTyxFQUFFLFdBQW9COztJQUNuRixNQUFNLE9BQU8sR0FBRyw2QkFBbUIsQ0FBQyxZQUFZLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUMzRCxJQUFJLGtCQUFrQixHQUFHLEVBQUUsQ0FBQTtJQUMzQixLQUFLLE1BQU0sTUFBTSxJQUFJLE9BQU8sRUFBRTtRQUU1QixJQUFJLFdBQVcsRUFBRTtZQUNmLElBQUk7Z0JBQ0YsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLFdBQVcsSUFBSSxNQUFNLENBQUMsZUFBZSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTthQUNsRztZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNWLElBQUksQ0FBQSxDQUFDLGFBQUQsQ0FBQyx1QkFBRCxDQUFDLENBQUUsSUFBSSxNQUFLLGtCQUFrQixFQUFFO29CQUNsQyxJQUFJO3dCQUNGLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxXQUFXLElBQUksTUFBTSxDQUFDLGVBQWUsRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFBO3dCQUNqRyxrQkFBa0IsSUFBSSxTQUFTLE9BQU8saURBQWlELE1BQUEsQ0FBQyxDQUFDLE9BQU8sbUNBQUksQ0FBQyxLQUFLLENBQUE7cUJBRTNHO29CQUFDLFdBQU0sR0FBRTtpQkFDWDthQUNGO1NBQ0Y7UUFDRCxNQUFNLGFBQWEsR0FBRyxXQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsUUFBUSxJQUFJLE1BQU0sQ0FBQyxlQUFlLE9BQU8sQ0FBQyxDQUFBO1FBQ2pGLElBQUksZUFBVSxDQUFDLGFBQWEsQ0FBQyxFQUFFO1lBQzdCLE9BQU8sT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFBO1NBQzlCO0tBQ0Y7SUFFRCxJQUFJLFdBQVcsR0FBRyxFQUFFLENBQUE7SUFFcEIsSUFBSSxXQUFXLEVBQUU7UUFDZixJQUFJO1lBR0YsTUFBTSwyQkFBMkIsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRyxDQUFBO1lBQ2pFLFdBQVcsR0FBRyxnQkFBVyxDQUFDLFdBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7aUJBQzVGLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLDJCQUEyQixJQUFJLENBQUMsQ0FBQyxVQUFVLENBQUMsMkJBQTJCLENBQUMsQ0FBQztpQkFDN0YsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1NBRWQ7UUFBQyxXQUFNLEdBQUU7S0FDWDtJQUVELE1BQU0sUUFBUSxHQUFHLHdCQUF3QixrQkFBa0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQzVGLFdBQVcsQ0FBQyxDQUFDLENBQUMsdUJBQXVCLEdBQUcsV0FBVyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFDOUQsRUFBRSxDQUFBO0lBRUYsTUFBTSxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQTtBQUMzQixDQUFDO0FBM0NELGtDQTJDQyJ9