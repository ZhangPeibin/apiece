{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, '__esModule', {\n  value: true\n});\n\nconst bcrypto = require('../crypto');\n\nconst networks_1 = require('../networks');\n\nconst bscript = require('../script');\n\nconst lazy = require('./lazy');\n\nconst typef = require('typeforce');\n\nconst OPS = bscript.OPS;\n\nconst bs58check = require('bs58check');\n\nfunction stacksEqual(a, b) {\n  if (a.length !== b.length) return false;\n  return a.every((x, i) => {\n    return x.equals(b[i]);\n  });\n} // input: [redeemScriptSig ...] {redeemScript}\n// witness: <?>\n// output: OP_HASH160 {hash160(redeemScript)} OP_EQUAL\n\n\nfunction p2sh(a, opts) {\n  if (!a.address && !a.hash && !a.output && !a.redeem && !a.input) throw new TypeError('Not enough data');\n  opts = Object.assign({\n    validate: true\n  }, opts || {});\n  typef({\n    network: typef.maybe(typef.Object),\n    address: typef.maybe(typef.String),\n    hash: typef.maybe(typef.BufferN(20)),\n    output: typef.maybe(typef.BufferN(23)),\n    redeem: typef.maybe({\n      network: typef.maybe(typef.Object),\n      output: typef.maybe(typef.Buffer),\n      input: typef.maybe(typef.Buffer),\n      witness: typef.maybe(typef.arrayOf(typef.Buffer))\n    }),\n    input: typef.maybe(typef.Buffer),\n    witness: typef.maybe(typef.arrayOf(typef.Buffer))\n  }, a);\n  let network = a.network;\n\n  if (!network) {\n    network = a.redeem && a.redeem.network || networks_1.bitcoin;\n  }\n\n  const o = {\n    network\n  };\n\n  const _address = lazy.value(() => {\n    const payload = bs58check.decode(a.address);\n    const version = payload.readUInt8(0);\n    const hash = payload.slice(1);\n    return {\n      version,\n      hash\n    };\n  });\n\n  const _chunks = lazy.value(() => {\n    return bscript.decompile(a.input);\n  });\n\n  const _redeem = lazy.value(() => {\n    const chunks = _chunks();\n\n    return {\n      network,\n      output: chunks[chunks.length - 1],\n      input: bscript.compile(chunks.slice(0, -1)),\n      witness: a.witness || []\n    };\n  }); // output dependents\n\n\n  lazy.prop(o, 'address', () => {\n    if (!o.hash) return;\n    const payload = Buffer.allocUnsafe(21);\n    payload.writeUInt8(o.network.scriptHash, 0);\n    o.hash.copy(payload, 1);\n    return bs58check.encode(payload);\n  });\n  lazy.prop(o, 'hash', () => {\n    // in order of least effort\n    if (a.output) return a.output.slice(2, 22);\n    if (a.address) return _address().hash;\n    if (o.redeem && o.redeem.output) return bcrypto.hash160(o.redeem.output);\n  });\n  lazy.prop(o, 'output', () => {\n    if (!o.hash) return;\n    return bscript.compile([OPS.OP_HASH160, o.hash, OPS.OP_EQUAL]);\n  }); // input dependents\n\n  lazy.prop(o, 'redeem', () => {\n    if (!a.input) return;\n    return _redeem();\n  });\n  lazy.prop(o, 'input', () => {\n    if (!a.redeem || !a.redeem.input || !a.redeem.output) return;\n    return bscript.compile([].concat(bscript.decompile(a.redeem.input), a.redeem.output));\n  });\n  lazy.prop(o, 'witness', () => {\n    if (o.redeem && o.redeem.witness) return o.redeem.witness;\n    if (o.input) return [];\n  });\n  lazy.prop(o, 'name', () => {\n    const nameParts = ['p2sh'];\n    if (o.redeem !== undefined) nameParts.push(o.redeem.name);\n    return nameParts.join('-');\n  });\n\n  if (opts.validate) {\n    let hash = Buffer.from([]);\n\n    if (a.address) {\n      if (_address().version !== network.scriptHash) throw new TypeError('Invalid version or Network mismatch');\n      if (_address().hash.length !== 20) throw new TypeError('Invalid address');\n      hash = _address().hash;\n    }\n\n    if (a.hash) {\n      if (hash.length > 0 && !hash.equals(a.hash)) throw new TypeError('Hash mismatch');else hash = a.hash;\n    }\n\n    if (a.output) {\n      if (a.output.length !== 23 || a.output[0] !== OPS.OP_HASH160 || a.output[1] !== 0x14 || a.output[22] !== OPS.OP_EQUAL) throw new TypeError('Output is invalid');\n      const hash2 = a.output.slice(2, 22);\n      if (hash.length > 0 && !hash.equals(hash2)) throw new TypeError('Hash mismatch');else hash = hash2;\n    } // inlined to prevent 'no-inner-declarations' failing\n\n\n    const checkRedeem = redeem => {\n      // is the redeem output empty/invalid?\n      if (redeem.output) {\n        const decompile = bscript.decompile(redeem.output);\n        if (!decompile || decompile.length < 1) throw new TypeError('Redeem.output too short'); // match hash against other sources\n\n        const hash2 = bcrypto.hash160(redeem.output);\n        if (hash.length > 0 && !hash.equals(hash2)) throw new TypeError('Hash mismatch');else hash = hash2;\n      }\n\n      if (redeem.input) {\n        const hasInput = redeem.input.length > 0;\n        const hasWitness = redeem.witness && redeem.witness.length > 0;\n        if (!hasInput && !hasWitness) throw new TypeError('Empty input');\n        if (hasInput && hasWitness) throw new TypeError('Input and witness provided');\n\n        if (hasInput) {\n          const richunks = bscript.decompile(redeem.input);\n          if (!bscript.isPushOnly(richunks)) throw new TypeError('Non push-only scriptSig');\n        }\n      }\n    };\n\n    if (a.input) {\n      const chunks = _chunks();\n\n      if (!chunks || chunks.length < 1) throw new TypeError('Input too short');\n      if (!Buffer.isBuffer(_redeem().output)) throw new TypeError('Input is invalid');\n      checkRedeem(_redeem());\n    }\n\n    if (a.redeem) {\n      if (a.redeem.network && a.redeem.network !== network) throw new TypeError('Network mismatch');\n\n      if (a.input) {\n        const redeem = _redeem();\n\n        if (a.redeem.output && !a.redeem.output.equals(redeem.output)) throw new TypeError('Redeem.output mismatch');\n        if (a.redeem.input && !a.redeem.input.equals(redeem.input)) throw new TypeError('Redeem.input mismatch');\n      }\n\n      checkRedeem(a.redeem);\n    }\n\n    if (a.witness) {\n      if (a.redeem && a.redeem.witness && !stacksEqual(a.redeem.witness, a.witness)) throw new TypeError('Witness and redeem.witness mismatch');\n    }\n  }\n\n  return Object.assign(o, a);\n}\n\nexports.p2sh = p2sh;","map":{"version":3,"sources":["/Users/wiki/code/filecoin/private.storage/node_modules/bitcoinjs-lib/src/payments/p2sh.js"],"names":["Object","defineProperty","exports","value","bcrypto","require","networks_1","bscript","lazy","typef","OPS","bs58check","stacksEqual","a","b","length","every","x","i","equals","p2sh","opts","address","hash","output","redeem","input","TypeError","assign","validate","network","maybe","String","BufferN","Buffer","witness","arrayOf","bitcoin","o","_address","payload","decode","version","readUInt8","slice","_chunks","decompile","_redeem","chunks","compile","prop","allocUnsafe","writeUInt8","scriptHash","copy","encode","hash160","OP_HASH160","OP_EQUAL","concat","nameParts","undefined","push","name","join","from","hash2","checkRedeem","hasInput","hasWitness","richunks","isPushOnly","isBuffer"],"mappings":"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","sourcesContent":["'use strict';\nObject.defineProperty(exports, '__esModule', { value: true });\nconst bcrypto = require('../crypto');\nconst networks_1 = require('../networks');\nconst bscript = require('../script');\nconst lazy = require('./lazy');\nconst typef = require('typeforce');\nconst OPS = bscript.OPS;\nconst bs58check = require('bs58check');\nfunction stacksEqual(a, b) {\n  if (a.length !== b.length) return false;\n  return a.every((x, i) => {\n    return x.equals(b[i]);\n  });\n}\n// input: [redeemScriptSig ...] {redeemScript}\n// witness: <?>\n// output: OP_HASH160 {hash160(redeemScript)} OP_EQUAL\nfunction p2sh(a, opts) {\n  if (!a.address && !a.hash && !a.output && !a.redeem && !a.input)\n    throw new TypeError('Not enough data');\n  opts = Object.assign({ validate: true }, opts || {});\n  typef(\n    {\n      network: typef.maybe(typef.Object),\n      address: typef.maybe(typef.String),\n      hash: typef.maybe(typef.BufferN(20)),\n      output: typef.maybe(typef.BufferN(23)),\n      redeem: typef.maybe({\n        network: typef.maybe(typef.Object),\n        output: typef.maybe(typef.Buffer),\n        input: typef.maybe(typef.Buffer),\n        witness: typef.maybe(typef.arrayOf(typef.Buffer)),\n      }),\n      input: typef.maybe(typef.Buffer),\n      witness: typef.maybe(typef.arrayOf(typef.Buffer)),\n    },\n    a,\n  );\n  let network = a.network;\n  if (!network) {\n    network = (a.redeem && a.redeem.network) || networks_1.bitcoin;\n  }\n  const o = { network };\n  const _address = lazy.value(() => {\n    const payload = bs58check.decode(a.address);\n    const version = payload.readUInt8(0);\n    const hash = payload.slice(1);\n    return { version, hash };\n  });\n  const _chunks = lazy.value(() => {\n    return bscript.decompile(a.input);\n  });\n  const _redeem = lazy.value(() => {\n    const chunks = _chunks();\n    return {\n      network,\n      output: chunks[chunks.length - 1],\n      input: bscript.compile(chunks.slice(0, -1)),\n      witness: a.witness || [],\n    };\n  });\n  // output dependents\n  lazy.prop(o, 'address', () => {\n    if (!o.hash) return;\n    const payload = Buffer.allocUnsafe(21);\n    payload.writeUInt8(o.network.scriptHash, 0);\n    o.hash.copy(payload, 1);\n    return bs58check.encode(payload);\n  });\n  lazy.prop(o, 'hash', () => {\n    // in order of least effort\n    if (a.output) return a.output.slice(2, 22);\n    if (a.address) return _address().hash;\n    if (o.redeem && o.redeem.output) return bcrypto.hash160(o.redeem.output);\n  });\n  lazy.prop(o, 'output', () => {\n    if (!o.hash) return;\n    return bscript.compile([OPS.OP_HASH160, o.hash, OPS.OP_EQUAL]);\n  });\n  // input dependents\n  lazy.prop(o, 'redeem', () => {\n    if (!a.input) return;\n    return _redeem();\n  });\n  lazy.prop(o, 'input', () => {\n    if (!a.redeem || !a.redeem.input || !a.redeem.output) return;\n    return bscript.compile(\n      [].concat(bscript.decompile(a.redeem.input), a.redeem.output),\n    );\n  });\n  lazy.prop(o, 'witness', () => {\n    if (o.redeem && o.redeem.witness) return o.redeem.witness;\n    if (o.input) return [];\n  });\n  lazy.prop(o, 'name', () => {\n    const nameParts = ['p2sh'];\n    if (o.redeem !== undefined) nameParts.push(o.redeem.name);\n    return nameParts.join('-');\n  });\n  if (opts.validate) {\n    let hash = Buffer.from([]);\n    if (a.address) {\n      if (_address().version !== network.scriptHash)\n        throw new TypeError('Invalid version or Network mismatch');\n      if (_address().hash.length !== 20) throw new TypeError('Invalid address');\n      hash = _address().hash;\n    }\n    if (a.hash) {\n      if (hash.length > 0 && !hash.equals(a.hash))\n        throw new TypeError('Hash mismatch');\n      else hash = a.hash;\n    }\n    if (a.output) {\n      if (\n        a.output.length !== 23 ||\n        a.output[0] !== OPS.OP_HASH160 ||\n        a.output[1] !== 0x14 ||\n        a.output[22] !== OPS.OP_EQUAL\n      )\n        throw new TypeError('Output is invalid');\n      const hash2 = a.output.slice(2, 22);\n      if (hash.length > 0 && !hash.equals(hash2))\n        throw new TypeError('Hash mismatch');\n      else hash = hash2;\n    }\n    // inlined to prevent 'no-inner-declarations' failing\n    const checkRedeem = redeem => {\n      // is the redeem output empty/invalid?\n      if (redeem.output) {\n        const decompile = bscript.decompile(redeem.output);\n        if (!decompile || decompile.length < 1)\n          throw new TypeError('Redeem.output too short');\n        // match hash against other sources\n        const hash2 = bcrypto.hash160(redeem.output);\n        if (hash.length > 0 && !hash.equals(hash2))\n          throw new TypeError('Hash mismatch');\n        else hash = hash2;\n      }\n      if (redeem.input) {\n        const hasInput = redeem.input.length > 0;\n        const hasWitness = redeem.witness && redeem.witness.length > 0;\n        if (!hasInput && !hasWitness) throw new TypeError('Empty input');\n        if (hasInput && hasWitness)\n          throw new TypeError('Input and witness provided');\n        if (hasInput) {\n          const richunks = bscript.decompile(redeem.input);\n          if (!bscript.isPushOnly(richunks))\n            throw new TypeError('Non push-only scriptSig');\n        }\n      }\n    };\n    if (a.input) {\n      const chunks = _chunks();\n      if (!chunks || chunks.length < 1) throw new TypeError('Input too short');\n      if (!Buffer.isBuffer(_redeem().output))\n        throw new TypeError('Input is invalid');\n      checkRedeem(_redeem());\n    }\n    if (a.redeem) {\n      if (a.redeem.network && a.redeem.network !== network)\n        throw new TypeError('Network mismatch');\n      if (a.input) {\n        const redeem = _redeem();\n        if (a.redeem.output && !a.redeem.output.equals(redeem.output))\n          throw new TypeError('Redeem.output mismatch');\n        if (a.redeem.input && !a.redeem.input.equals(redeem.input))\n          throw new TypeError('Redeem.input mismatch');\n      }\n      checkRedeem(a.redeem);\n    }\n    if (a.witness) {\n      if (\n        a.redeem &&\n        a.redeem.witness &&\n        !stacksEqual(a.redeem.witness, a.witness)\n      )\n        throw new TypeError('Witness and redeem.witness mismatch');\n    }\n  }\n  return Object.assign(o, a);\n}\nexports.p2sh = p2sh;\n"]},"metadata":{},"sourceType":"script"}